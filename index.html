<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>侦探档案馆 - 剧本杀 (TTS旁白增强完整版)</title>
    
    <style>
        /* ===================================================================
           CSS 样式 (保持简洁和深色主题)
           =================================================================== */
        
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        #app-container {
            width: 100%;
            max-width: 900px;
            background-color: #1e1e1e;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            padding-bottom: 20px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #2a2a2a;
            border-bottom: 2px solid #3c3c3c;
        }

        .app-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #f7b731;
        }

        .menu-btn {
            background-color: #3c3c3c;
            color: #e0e0e0;
            border: none;
            padding: 8px 15px;
            margin-left: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9em;
        }
        
        .menu-btn-tts { /* 专门为TTS按钮设置的样式 */
            background-color: #17a2b8; /* 默认关闭状态 */
        }
        .menu-btn-tts.tts-on {
            background-color: #28a745; /* 开启状态 */
        }

        .scene {
            padding: 30px;
            display: none;
            min-height: 500px;
        }

        .scene.active {
            display: block;
        }

        .scene-title {
            color: #f7b731;
            text-align: center;
            margin-bottom: 40px;
        }

        .case-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .case-card {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .case-card:hover {
            transform: translateY(-5px);
            border-color: #f7b731;
        }

        .case-tags {
            font-size: 0.8em;
            color: #79c9f7;
            margin-top: -10px;
            margin-bottom: 10px;
        }

        .role-input-box {
            background-color: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
        }

        #role-name-options {
            color: #79c9f7;
            margin-bottom: 15px;
            font-size: 0.9em;
            text-align: left;
            padding: 0 15%;
        }

        #role-name-input {
            padding: 10px;
            width: 60%;
            margin: 15px auto;
            display: block;
            border: 1px solid #444;
            background-color: #1e1e1e;
            color: #fff;
            border-radius: 4px;
        }

        .confirm-button {
            background-color: #e74c3c;
            color: white;
            padding: 10px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .role-script-area {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #555;
            background-color: #1e1e1e;
            text-align: left;
            min-height: 150px;
        }

        .role-script-area p {
            margin: 10px 0;
            line-height: 1.6;
        }
        .role-script-area strong {
            color: #f7b731;
        }
        .role-script-area span {
            color: #fff;
        }

        /* 场景图片样式 */
        .scene-image-container {
            height: 300px; 
            overflow: hidden;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .scene-image {
            width: 100%;
            height: 100%;
            object-fit: cover; 
        }
        
        .narrative-box {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .narrative-text {
            font-size: 1.1em;
            line-height: 1.8;
            color: #ccc; 
        }

        .action-btn {
            background-color: #e74c3c;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: block;
            width: 100%;
            margin-top: 20px;
            font-size: 1.1em;
            transition: background-color 0.3s;
        }

        .clue-item {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 5px solid #79c9f7;
        }
    </style>
</head>
<body>
    <div id="app-container">
        
        <header class="top-bar">
            <span class="app-title">🕵️ 侦探档案馆</span>
            <div class="menu-controls">
                <button id="tts-toggle" class="menu-btn menu-btn-tts">🔊 TTS: 关</button> 
                <button id="menu-btn" class="menu-btn">📋 菜单</button>
            </div>
        </header>

        <main id="game-content">
            
            <div id="scene-case-select" class="scene active">
                <h1 class="scene-title">选择今日案件 (共 12 个完整剧本)</h1>
                <div class="case-list" id="case-list-container">
                    </div>
            </div>

            <div id="scene-role-select" class="scene">
                <div class="role-input-box">
                    <h2>你的角色剧本</h2>
                    <p>请**输入你被分配到的角色名**，查看你的秘密。</p>
                    <p id="role-name-options">可输入角色名: 待加载...</p>
                    
                    <input type="text" id="role-name-input" placeholder="输入角色名">
                    <button id="confirm-role-btn" class="confirm-button">确认</button>
                    
                    <div id="role-script-display" class="role-script-area">
                        </div>
                </div>
            </div>

            <div id="scene-narrative" class="scene">
                <div class="scene-image-container">
                    <img id="scene-main-image" class="scene-image" src="" alt="场景插图占位符">
                </div>
                
                <div class="narrative-box">
                    <p id="narrative-text" class="narrative-text">【旁白】故事将在这里展开...</p>
                </div>
                
                <button id="continue-story-btn" class="action-btn">继续故事 ▶</button>
            </div>

            <div id="scene-clues" class="scene">
                <h2 class="clue-title">🔍 搜证阶段: 线索列表</h2>
                <p id="clue-stage-info" style="text-align: center; color: #aaa; margin-bottom: 20px;">本次搜证有 0 条线索。</p>
                
                <div id="clue-list-container">
                    </div>
                
                <button id="finish-clues-btn" class="action-btn">结束搜证，进入下一轮讨论</button>
            </div>
            
            <div id="scene-reveal" class="scene">
                <h2 class="scene-title">身份揭晓 · 传闻模式</h2>
                <p>【主持人】请大家给出最终指认，并解释你的逻辑。</p>
                <div class="reveal-content">
                    <p id="final-reveal-text" style="background-color: #2a2a2a; padding: 20px; border-radius: 8px; line-height: 1.8;">
                        **案件真相：**
                        <br>
                        <span id="truth-display">（真相在此处揭晓）</span>
                    </p>
                </div>
                <button class="action-btn" onclick="goToScene('scene-case-select')">返回案件选择</button>
            </div>

        </main>
    </div>
    
    <div id="menu-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-menu">&times;</span>
            <h2>📋 游戏菜单</h2>
            <p>这里可以放置游戏的设置和退出选项。</p>
            <button class="confirm-button" onclick="goToScene('scene-case-select'); document.getElementById('menu-modal').style.display='none';">返回案件选择</button>
        </div>
    </div>

    <script>
        // ===================================================================
        // 1. 核心数据 (Data) - 案件结构
        // ===================================================================

        let game = {
            currentCaseId: null,
            currentCaseData: null,
            currentSceneIndex: 0,
            ttsOn: false, 
            roleName: null,
            currentClueStage: 1
        };

        const BASIC_SCENES_TEMPLATE = [
        { type: 'narrative', text: '【旁白】紧张的氛围充斥着现场。这是一桩精心策划的谜局，每一句话都可能是一个谎言。', audio: '' },
        { type: 'narrative', text: '【主持人】各位请保持冷静。现在已有初步线索。', audio: '' },
        { type: 'clues_stage', stage: 1 }, 
        { type: 'select_role' },
        { type: 'narrative', text: '【主持人】角色剧本已分配完毕。现在开始 **第一轮陈述**，请各位根据自己的剧本信息进行自我介绍和详细陈述。', audio: '' },
        { type: 'narrative', text: '【主持人】第二轮线索已发放。请各位结合剧本内容和现场线索，进行 **第二轮深入讨论**，注意辨别真假信息。', audio: '' },
        { type: 'clues_stage', stage: 2 }, 
        { type: 'narrative', text: '【主持人】所有线索已发放完毕。请各位进行 **最终的总结讨论**，找出隐藏在谎言链条中的真相。', audio: '' },
        { type: 'narrative', text: '【主持人】现在是 **最终指认环节**。请每位玩家依次指出你认为的真凶，并给出你的推理依据。', audio: '' },
        { type: 'reveal' }
    ];

        // 场景图片路径：统一使用您指定的格式。
        const SCENE_IMAGES = {
            '01': '1.jpg', 
            '02': '1.jpg', 
            '03': '1.jpg', 
            '04': '1.jpg', 
            '05': '1.jpg', 
            '06': '1.jpg', 
            '07': '1.jpg', 
            '08': '1.jpg', 
            '09': '1.jpg', 
            '10': '1.jpg', 
            '11': '1.jpg', 
            '12': '1.jpg', 
        };

    
    const GAME_DATA = {
        // 案件 01: 未干的雨伞 (复杂/困难)
        '01': {
            title: '未干的雨伞', tags: '【复杂】 【密室】 【三重时间差】', description: '暴雨夜，富翁死在密闭书房。完美密室背后，是数个角色之间互相掩盖的谎言链。',
            roles: {
                '女佣·林小梅': { identity: '林小梅 (女佣)', secret: '【真】9:50看到书房反锁。【假】你告诉警方你听到9:10有钥匙转动的声音。你知晓夫人与医生有私情。', task: '隐瞒你看到夫人和医生曾单独在客厅交谈的事实，并引导警方注意9:10的声音。', options: ['女佣·林小梅', '医生·秦文江', '夫人·李若兰', '管家·孙福'] },
                '医生·秦文江': { identity: '秦文江 (私人医生)', secret: '【凶手】【真】9:40用雕像杀人。【假】你谎称9:00返回。你偷偷给了管家一笔钱，让他帮你处理那把湿伞，作为情感回报。', task: '坚称你9:00返回，并暗示湿雨伞是管家帮你拿进来时沾上的。' },
                '夫人·李若兰': { identity: '李若兰 (死者妻子)', secret: '【真】你8:00-9:00与秦医生幽会，回来时雨刚停。【假】你告诉警方你与死者有激烈争吵，并威胁要离开。', task: '极力维护秦医生的不在场证明，并转移对自己的怀疑。' },
                '管家·孙福': { identity: '孙福 (老管家)', secret: '【真】9:20看到医生进入，故意把湿伞放显眼处。【假】你告诉警方你调整雨伞是为了避免水滴损坏地板。你确实收了医生一笔钱，但目的是销毁那根细铁丝。', task: '如实说出看到秦医生进入的时间，但不能透露夫人和秦医生的关系。' }
            },
            scenes: BASIC_SCENES_TEMPLATE,
            clue_stages: {
                1: [
                    { title: '1. 尸检报告', detail: '死亡时间 9:30-10:00，钝器重击致死。' }, 
                    { title: '2. 气象记录与雨伞', detail: '9:15雨势停止。秦医生的伞是湿淋淋的，伞柄处有管家和医生的指纹。' },
                    { title: '3. 门厅的监控片段', detail: '管家·孙福在9:30曾进入门厅，调整了秦医生的雨伞位置。' }
                ],
                2: [
                    { title: '4. 雕像上的痕迹', detail: '雕像底部有夫人和医生的指纹（夫人是在案发后清理时留下的）。' }, 
                    { title: '5. 管家外套口袋', detail: '在管家的外套口袋发现了秦医生丢失的细铁丝。' },
                    { title: '6. 误导信息', detail: '在书房发现了一张被烧毁的纸条，内容是“分手信”。' }
                ]
            },
            truth: '真凶是医生·秦文江。他9:20才到家，用细铁丝转动钥匙进入书房杀人。他给管家钱，让管家销毁细铁丝，但管家在收钱的同时，将湿伞作为证据留给了警方。'
        },
        
        // 案件 02: 被毒杀的金丝雀 (复杂/困难)
        '02': { 
            title: '被毒杀的金丝雀', tags: '【复杂】 【宫廷】 【接触性延时毒杀】', description: '宴席上所有人都饮了同一壶酒，为何只有宠妃中毒身亡？毒药被涂在了她每日佩戴的首饰上，通过特定动作生效。', 
            roles: { 
                '皇后·李玉婷': {identity:'李玉婷 (皇后)', secret: '【真】你送给宠妃藏有慢性毒针的金丝皇冠。 【假】你声称金针只是装饰，并说你看到太医曾偷偷给宠妃一个安神药丸。', task: '隐瞒你赠送金丝皇冠时藏毒针的事实，并转移对自己的怀疑。', options: ['皇后·李玉婷', '侍卫长·赵武', '太医·孙正', '宫女·柳儿'] }, 
                '侍卫长·赵武': {identity:'赵武 (侍卫长)', secret: '【真】你看到宠妃饮酒前，用皇冠上的金针扎了一下绣花丝绸擦嘴。 【假】你告诉警方你在宴会期间，曾短暂离开去检查宫门。', task: '详细描述宠妃饮酒前的特殊习惯和动作。'}, 
                '太医·孙正': {identity:'孙正 (太医)', secret: '【凶手】【真】你替换了皇后皇冠上的毒针，换成了能快速溶解发作的剧毒，以嫁祸给皇后。 【假】你坚称宠妃是酒中中毒，并试图通过伪造毒药溶解时间，将罪责引向皇后。', task: '坚称宠妃是酒中中毒，并试图通过伪造毒药溶解时间，将罪责引向皇后。'}, 
                '宫女·柳儿': {identity:'柳儿 (宫女)', secret: '【真】你收集了皇后赠送皇冠时的包裹物，上面有太医的指纹。 【假】你向皇后索要封口费，并暗示如果皇后被定罪，你将公开包裹物。', task: '在讨论中透露皇后送礼的包裹曾被太医接触过。'} 
            }, 
            scenes: BASIC_SCENES_TEMPLATE, clue_stages: { 
                1: [
                    { title: '1. 毒发症状', detail: '中毒速度极快。酒壶、酒杯均呈阴性。' }, 
                    { title: '2. 宠妃的皇冠', detail: '皇冠顶端藏有一根微小的金针，金针上检测出剧毒残留。' },
                    { title: '3. 误导信息', detail: '在太医的医书中发现了一张关于“快速溶解安神药丸”的笔记。' }
                ], 
                2: [
                    { title: '4. 太医的药方记录', detail: '太医近期的药方中，有一种剧毒的解药成分突然消失。' }, 
                    { title: '5. 侍卫长的证词', detail: '宠妃有饮酒前用金针刺绣布擦嘴的习惯，该绣布上有微量毒药和酒渍。' },
                    { title: '6. 包裹物上的指纹', detail: '皇后赠送皇冠的包裹物上有太医的指纹。' }
                ] 
            }, 
            truth: '真凶是太医·孙正。他发现了皇后藏毒的计划，将皇后的慢性毒药替换为速溶剧毒，涂在金针上。宠妃按照习惯用金针刺绣布擦嘴时，毒药通过丝绸进入体内，实现了嫁祸皇后的目的。' 
        },
        
        // 案件 03: 雪山上的红酒渍 (极难)
        '03': { 
            title: '雪山上的红酒渍', tags: '【极难】 【环境】 【化学诡计】', description: '封闭的雪山酒店，作家死于红酒。毒药利用高海拔气压和环境温度完成精确投毒，凶手逃离现场使用了三重伪装。', 
            roles: { 
                '厨师·张大明': {identity:'张大明 (厨师)', secret: '【真】看到编辑·周强在死者房间的屋顶排气口附近徘徊。 【假】你告诉警方你与死者有巨额赌债纠纷，并声称死者曾威胁你。', task: '重点指出编辑在屋顶的可疑行为，但隐藏自己的赌债。', options: ['厨师·张大明', '服务生·小李', '编辑·周强', '游客·王芳'] }, 
                '服务生·小李': {identity:'小李 (服务生)', secret: '【真】送酒时红酒溅出托盘。你偷偷拿走了作家用于测量气压的微型仪器。 【假】你声称作家曾向你抱怨房间内的暖气片温度不稳定。', task: '如实说出送酒时红酒溅出，但隐瞒拿走气压仪器的行为，并转移对自己的怀疑。'}, 
                '编辑·周强': {identity:'周强 (编辑)', secret: '【凶手】【真】你将高挥发性毒剂藏于气压装置内，通过屋顶排气口，利用室内外温差和气压变化，精确地滴入了红酒杯中的一个**特定冰块**。你穿着滑雪板，又在滑雪板下绑了雪鞋，伪装了两次脚印。 【假】你声称你当天携带的蜡块是用来修补滑雪板的，坚称自己有完美的不在场证明。', task: '解释你当天携带的蜡块是用来修补滑雪板的，坚称自己有完美的不在场证明。'}, 
                '游客·王芳': {identity:'王芳 (游客)', secret: '【真】你曾潜入作家房间偷窃手稿，离开时发现作家常戴的指南针遗落。 【假】你告诉警方你在雪地看到一个影子在拖行什么东西（其实是编辑在拖动伪装用的毯子）。', task: '隐瞒你潜入房间的企图，只说看到指南针遗落的事实。'} 
            }, 
            scenes: BASIC_SCENES_TEMPLATE, clue_stages: { 
                1: [
                    { title: '1. 雪地脚印', detail: '雪地有两层脚印：第一层是滑雪板痕迹，第二层是细小雪鞋痕迹，但没有返回痕迹。' }, 
                    { title: '2. 红酒分析', detail: '酒瓶无毒，杯中残留高剂量氰化物。但毒物只集中在杯底边缘，像是从顶部或侧面滴入。' },
                    { title: '3. 屋顶排气口', detail: '排气口内壁发现一小块残留的微型气压装置碎片和高挥发性毒剂的痕迹。' }
                ], 
                2: [
                    { title: '4. 服务生拿走的仪器', detail: '气压仪器的气压记录，与案发当晚的气压波动记录吻合。' }, 
                    { title: '5. 托盘防滑垫', detail: '托盘防滑垫上的红酒渍是无法清理的**特殊染料**，与编辑携带的蜡块成分吻合。' },
                    { title: '6. 误导信息', detail: '作家房间内发现一张写有“温度是关键”的字条。' }
                ] 
            }, 
            truth: '真凶是编辑·周强。他利用气压装置和温差，将高挥发性毒剂精确滴入红酒杯中的**特定冰块**。他穿着滑雪板，下绑雪鞋，伪造了多重足迹混淆侦查。托盘上的染料是他在伪装时无意中留下的痕迹。' 
        },
    
        // 案件 04: 凌晨三点的电话 (复杂)
        '04': { 
            title: '凌晨三点的电话', tags: '【复杂】 【不在场证明】 【连环伪造】', description: '死者死前拨打了一个空号长达五分钟。电话时间与死亡时间看似一致，实则牵扯出一桩复杂的金融勒索案。', 
            roles: { 
                '前男友·李昊': {identity:'李昊 (前男友)', secret: '【真】2:30曾潜入死者房间，试图拿回一个录有金融犯罪证据的U盘。 【假】你偷偷拿走了死者桌上的一个未签署合同。', task: '极力证明你在2:55前就已经离开了，并强调死者与外界的纠纷。', options: ['前男友·李昊', '闺蜜·陈思', '邻居·老王', '警察·周警官'] }, 
                '闺蜜·陈思': {identity:'陈思 (闺蜜)', secret: '【凶手】【真】2:55分作案。你利用死者手机的“定时外呼”功能，设定在3:00自动拨打空号，伪造求救，以掩盖你与死者合谋勒索的秘密。 【假】你坚称你听到电话铃声后才赶到现场，并试图引导怀疑前男友·李昊拿走了U盘。', task: '坚称你听到电话铃声后才赶到现场，并试图引导怀疑前男友·李昊拿走了U盘。'}, 
                '邻居·老王': {identity:'老王 (邻居)', secret: '【真】2:55分听到女性尖叫声，但3:00电话声响起时，尖叫声已停止。你还看到一个黑影从窗户旁的消防梯上爬下。 【假】你告诉警方你看到黑影手中拿着一个闪光的物品（其实是前男友的钥匙扣）。', task: '如实说出你听到尖叫声和电话声的时间差，以及你看到黑影逃离的事实。'}, 
                '警察·周警官': {identity:'周警官 (警察)', secret: '【真】你发现闺蜜·陈思的手机曾与死者的手机进行过一次“定时外呼”设置同步。 【假】你告诉警方你发现死者手机里有一条未发送的短信：“我把U盘藏在了咖啡罐里”。', task: '找到并指出闺蜜手机定时外呼的痕迹和同步记录。'} 
            }, 
            scenes: BASIC_SCENES_TEMPLATE, clue_stages: { 
                1: [
                    { title: '1. 电话记录', detail: '死者手机在3:00拨打了一个空号，长达5分钟，但房间有搏斗痕迹。' }, 
                    { title: '2. 邻居证词', detail: '邻居在2:55分听到女性尖叫声，3:00电话响起前尖叫停止。' },
                    { title: '3. 手机同步记录', detail: '技术人员发现闺蜜手机在案发前曾与死者手机进行“定时外呼”功能同步。' }
                ], 
                2: [
                    { title: '4. 现场痕迹', detail: '现场未发现U盘，但咖啡罐中发现了U盘。' }, 
                    { title: '5. 前男友的钥匙与合同', detail: '前男友的钥匙遗失在死者家门口，他偷偷拿走的合同内容是关于死者和闺蜜的利益分配。' },
                    { title: '6. 误导信息', detail: '消防梯上有被重物摩擦的痕迹。' }
                ] 
            }, 
            truth: '真凶是闺蜜·陈思。她与死者合谋勒索，因分赃不均杀人。她在2:55分作案，然后利用手机同步功能启动了死者手机的定时外呼，伪造求救。前男友拿走合同，暴露了他知道勒索案的秘密。' 
        },
            
        // 案件 05: 画廊失窃案 (复杂)
        '05': { 
            title: '画廊失窃案', tags: '【复杂】 【密室窃案】 【双重机关】', description: '名画失窃于密不透风的画廊。警报无损，门窗完好。凶手利用了馆长和艺术家各自留下的安保漏洞。', 
            roles: { 
                '馆长·方华': {identity:'方华 (馆长)', secret: '【真】你在画框旁安装了一个隐蔽的**电源开关**，可以轻微松动螺丝。 【假】你告诉警方你收到过一封警告信，内容是“画廊的灯光设计有问题”。', task: '隐瞒电源开关的存在，并坚持安保系统是绝对完美的。', options: ['馆长·方华', '保安·王军', '艺术家·张宁', '清洁工·刘妈'] }, 
                '保安·王军': {identity:'王军 (保安)', secret: '【凶手】【真】你发现了馆长的开关和艺术家的记号，利用它们抬起画框取出画作。 【假】你坚决否认你对画框或电源做过任何操作，并说你经常看到艺术家在画框附近徘徊。', task: '坚决否认你对画框或电源做过任何操作。'}, 
                '艺术家·张宁': {identity:'张宁 (原作者)', secret: '【真】你在画框底部做了**特殊记号**测试安保漏洞，并发现记号被多次刮擦。 【假】你告诉警方你曾在警卫换岗时看到馆长在画框旁进行可疑操作。', task: '只承认自己留下记号，但隐瞒记号被多次刮擦的事实。'}, 
                '清洁工·刘妈': {identity:'刘妈 (清洁工)', secret: '【真】你看到保安王军经常按墙壁上的一个微小凸起（开关）。 【假】你声称你看到画作的颜料似乎有点松动，你曾试图用手去摸。', task: '如实说出看到保安的异常“按压”行为。'} 
            }, 
            scenes: BASIC_SCENES_TEMPLATE, 
            clue_stages: { 
                1: [
                    { title: '1. 警报系统报告', detail: '警报无异常。画作尺寸巨大，无法卷曲。' }, 
                    { title: '2. 墙壁微小凸起', detail: '这是一个隐蔽的电源开关，且有被频繁按压的痕迹。' },
                    { title: '3. 画框螺丝与记号', detail: '画框下方的螺丝松动，且艺术家留下的记号有被工具撬动的痕迹。' }
                ], 
                2: [
                    { title: '4. 保安的财务报告', detail: '保安·王军购买了一个工业级微型千斤顶。' }, 
                    { title: '5. 警告信的墨水', detail: '警告信墨水成分与馆长办公室使用的墨水成分一致。' },
                    { title: '6. 误导信息', detail: '在画廊角落发现了一根未烧尽的蜡烛，暗示有人使用过蜡烛来封锁门缝。' }
                ] 
            }, 
            truth: '真凶是保安·王军。他利用馆长私设的电源开关松动螺丝，然后用千斤顶抬升画框，取出画作。馆长收到警告信是自导自演，为了将注意力引向外部。' 
        },
    
        // 案件 06: 沙滩上的脚印 (中等)
        '06': { 
            title: '沙滩上的脚印', tags: '【中等】 【环境】 【伪装痕迹】', description: '退潮沙滩上，只有一组走向尸体的脚印。凶手利用了可拆卸鞋底和酒店经理的私密行动来掩盖作案时间。', 
            roles: { 
                '冲浪者·陈磊': {identity:'陈磊 (冲浪者)', secret: '【真】你看到了渔夫在退潮时匆忙地把一双鞋子扔进了海里，并且他脱下了一件很重的背心。 【假】你声称渔夫在海上曾向你贩卖走私烟酒。', task: '重点指出渔夫丢弃鞋子和脱下背心的行为。', options: ['冲浪者·陈磊', '渔夫·老李', '游客·周婷', '酒店经理·孙明'] }, 
                '渔夫·老李': {identity:'老李 (渔夫)', secret: '【凶手】【真】你用可以拆卸并反装的靴子鞋底，并穿着一件**配重的潜水背心**来模仿正常脚印的深度。 【假】你坚称你当天没有上岸，并指责经理私自修改潮汐表是为了掩盖自己的不法行为。', task: '坚称你当天没有上岸，并解释背心是用来潜水作业的。'}, 
                '游客·周婷': {identity:'周婷 (游客)', secret: '【真】你在阳台上看到了一个影子在沙滩上倒着走路，并且影子周围有一个小推车印记。 【假】你告诉警方你看到推车上装载着一个巨大的黑色包裹（其实是酒店垃圾）。', task: '如实说出你看到“倒着走路”的影子和推车印记。'}, 
                '酒店经理·孙明': {identity:'孙明 (经理)', secret: '【真】你私自修改了潮汐表，以延后大潮时间，是为了掩盖你偷偷将酒店垃圾倒入海滩的事实。 【假】你坚称潮汐表是正确的，否认修改事实。', task: '坚称潮汐表是正确的，否认修改事实。'} 
            }, 
            scenes: BASIC_SCENES_TEMPLATE, 
            clue_stages: { 
                1: [
                    { title: '1. 脚印深度分析', detail: '脚印深度远浅于正常行走，但又过于均匀，不像是空身行走。' }, 
                    { title: '2. 天文潮汐表与酒店潮汐表', detail: '酒店潮汐表被人为修改过，大潮时间延后了2小时。' },
                    { title: '3. 沙滩推车印记', detail: '推车印记附近有微量的酒店垃圾残留。' }
                ], 
                2: [
                    { title: '4. 渔夫的特殊装备', detail: '在渔夫住处发现了可拆卸的反转鞋底和一件**高配重的潜水背心**。' }, 
                    { title: '5. 走私烟酒', detail: '在冲浪者陈磊的储物柜中发现了走私烟酒，证明他与渔夫的交易。' },
                    { title: '6. 误导信息', detail: '尸体旁边发现了一把破旧的铁锹。' }
                ] 
            }, 
            truth: '真凶是渔夫·老李。他将靴子的鞋底反装，并穿上配重的潜水背心，倒着走向海边，在海边将鞋底丢弃。酒店经理的修改潮汐表行为，无意中为他延长了作案时间。' 
        },
    
        // 案件 07: 咖啡厅的钥匙 (复杂)
        '07': { 
            title: '咖啡厅的钥匙', tags: '【复杂】 【证词】 【信任的背叛】', description: '嫌疑人有完美的不在场证明，但现场留下的钥匙暴露了盲点。这把钥匙是凶手故意留下的陷阱。', 
            roles: { 
                '嫌疑人·赵明': {identity:'赵明 (嫌疑人)', secret: '【真】你和死者有秘密的借贷关系，你曾将钥匙借给林辉。你和林辉在3:20离开了咖啡厅，但作伪证称待到7点。 【假】你声称你相信林辉是无辜的，并强调钥匙是你在回家路上发现不见的。', task: '坚持自己的不在场证明，并暗示钥匙可能是别人偷走的。', options: ['嫌疑人·赵明', '朋友·林辉', '服务员·小芳', '店长·李毅'] }, 
                '朋友·林辉': {identity:'林辉 (朋友)', secret: '【凶手】【真】你帮赵明作伪证，但你才是凶手。你利用赵明的钥匙进入死者家中作案，并故意将钥匙遗留在现场，旨在嫁祸赵明。 【假】你极力维护赵明的伪证，并声称你和赵明只是去看了场电影。', task: '极力维护赵明的伪证，并对钥匙出现在现场表示“不解”。'}, 
                '服务员·小芳': {identity:'小芳 (服务员)', secret: '【真】你用记号笔在赵明桌上的咖啡杯垫做了3:20的标记。你看到林辉离开咖啡厅后，又快速地返回了一趟，并从赵明的包里拿走了什么东西。 【假】你告诉警方你认为林辉返回是去拿遗落的手机。', task: '如实说出看到林辉二次返回咖啡厅的行为。'}, 
                '店长·李毅': {identity:'李毅 (店长)', secret: '【真】发现赵明手机3:25后就没有连接到咖啡厅WIFI。你发现林辉在咖啡厅有一个秘密储物柜，里面有一把与死者家相似的备用钥匙。 【假】你声称你曾看到死者和赵明在咖啡厅秘密交谈，关系非常亲密。', task: '在讨论中，隐晦地提到林辉的秘密储物柜和WIFI断开记录。'} 
            }, 
            scenes: BASIC_SCENES_TEMPLATE, 
            clue_stages: { 
                1: [
                    { title: '1. 咖啡厅收据与杯垫', detail: '收据时间是下午3点。服务员在3:20对桌子做了标记。' }, 
                    { title: '2. 嫌疑人钥匙', detail: '带有咖啡厅标志钥匙扣的钥匙遗留在案发现场。' },
                    { title: '3. 服务员的证词', detail: '林辉（朋友）在3:20离开后，曾快速返回。' }
                ], 
                2: [
                    { title: '4. 店长的秘密储物柜', detail: '店长在林辉的储物柜中发现了一把与死者家门钥匙结构相似的**钥匙坯子**。' }, 
                    { title: '5. WIFI记录', detail: '赵明手机在3:25后没有连接到咖啡厅WIFI。' },
                    { title: '6. 误导信息', detail: '在死者家中发现了一张电影票存根，时间与林辉声称看电影的时间吻合。' }
                ] 
            }, 
            truth: '真凶是朋友·林辉。他与赵明一同离开后，快速返回拿走了赵明的钥匙，进入死者家中作案。他故意留下赵明的钥匙，旨在将死者借贷的嫌疑引向赵明，掩盖自己与死者关于钥匙坯子的秘密。' 
        },
    
        // 案件 08: 迟到的遗嘱 (复杂)
        '08': { 
            title: '迟到的遗嘱', tags: '【复杂】 【文件证据】 【双重伪造】', description: '一份在病房签署的遗嘱，笔迹潦草。律师利用了医护流程和特殊药剂完成了高难度伪造。', 
            roles: { 
                '长子·王强': {identity:'王强 (长子)', secret: '【真】你贿赂了律师，给了他一支**含有微量感光染料**的钢笔，让签名在特定光线下消失。 【假】你坚决否认你认识那支钢笔，并声称幼女·王丽曾在签名完成后试图毁坏文件。', task: '重点质疑签名的稳定性，并强调老人当时的身体状况。', options: ['长子·王强', '幼女·王丽', '律师·刘杰', '护士·张静'] }, 
                '幼女·王丽': {identity:'王丽 (幼女)', secret: '【真】你在遗嘱签署前曾试图闯入病房，被护士阻止。 【假】你告诉警方你看到律师在签署前，曾将自己的钢笔和老人的钢笔进行过一次交换。', task: '说出你试图阻止签署遗嘱的事实，并指出护士曾与律师单独交谈。'}, 
                '律师·刘杰': {identity:'刘杰 (律师)', secret: '【凶手】【真】你收了长子的贿赂，但决定自己继承遗产。你用长子给的钢笔，在护士的帮助下，利用强效镇静剂和点滴架支撑老人完成了签名。 【假】你坚称签名是老人自己完成的，并否认与长子有任何贿赂。', task: '坚称签名是老人自己完成的，并否认与长子有任何贿赂。'}, 
                '护士·张静': {identity:'张静 (护士)', secret: '【真】你在遗嘱签署前20分钟给老人注射了大剂量的强效镇静剂，这是违反常规的。你被律师威胁，不得不协助他完成签名。 【假】你隐瞒镇静剂的剂量过大，只说按医嘱操作。', task: '隐瞒镇静剂的剂量过大和被威胁的事实。'} 
            }, 
            scenes: BASIC_SCENES_TEMPLATE, 
            clue_stages: { 
                1: [
                    { title: '1. 签名笔迹分析', detail: '笔迹力量走向一致，不符合常人书写。签名油墨在特定紫外光下有微弱的褪色反应。' }, 
                    { title: '2. 医疗记录', detail: '签署前20分钟注射了大剂量的**强效镇静剂**。' },
                    { title: '3. 律师的手部淤青', detail: '律师手指有轻微淤青。' }
                ], 
                2: [
                    { title: '4. 遗嘱上的印记与滑石粉', detail: '遗嘱纸张左侧有一个微小的圆形印记，与医院点滴架上的挂钩底部吻合。且印记附近有护士手套上的微量滑石粉残留。' }, 
                    { title: '5. 钢笔分析', detail: '律师使用的钢笔，笔尖有长子王强的指纹。' },
                    { title: '6. 误导信息', detail: '在幼女的房间里发现了一张试图模仿老人笔迹的练习纸。' }
                ] 
            }, 
            truth: '真凶是律师·刘杰。他收了长子的贿赂，但选择背叛长子，自己伪造遗嘱。他利用镇静剂使老人神志不清，并让护士协助他，靠在点滴架上完成签名。长子提供的钢笔的感光染料，证明了长子的参与和签名是伪造的。' 
        },
    
        // 案件 09: 被诅咒的古董店 (复杂)
        '09': { 
            title: '被诅咒的古董店', tags: '【复杂】 【物理机关】 【迷信伪装】', description: '店主被自己的收藏砸死，尸体周围是散乱的符咒。机关被触发的关键，是店主的一个日常习惯。', 
            roles: { 
                '道士·张玄': {identity:'张玄 (风水师)', secret: '【真】你看到店主有一个习惯，每天早上都会摇动一个放在架子上的小铜铃（幸运物）。 【假】你告诉警方你曾看到店主在花瓶展示架的底部涂抹了一种特殊的油。', task: '说出店主摇动小铜铃的日常习惯。', options: ['道士·张玄', '学徒·小陈', '收藏家·李德', '盗墓贼·钱涛'] }, 
                '学徒·小陈': {identity:'小陈 (学徒)', secret: '【真】你看到盗墓贼在案发前一天，在墙壁上安装了一个**声敏传感器**。 【假】你声称你看到盗墓贼进入时，携带了一个巨大的卷轴，可能就是被砸碎的花瓶。', task: '指出隔壁储物间有人进入，并暗示声敏传感器的存在。'}, 
                '收藏家·李德': {identity:'李德 (竞争对手)', secret: '【真】你发现现场烧焦的纸条与一个你正在寻找的特殊符咒的包装相似。 【假】你否认自己对店主有恶意，并坚称你在案发时正在和另一个竞争对手通电话。', task: '否认自己对店主有恶意，并将重点放在店里散落的符咒上，暗示诅咒。'}, 
                '盗墓贼·钱涛': {identity:'钱涛 (盗墓贼)', secret: '【凶手】【真】你安装了声敏传感器，利用店主摇铜铃的习惯触发机关。你将传感器与鱼线连接，鱼线在花瓶断裂后，被你远程焚烧。 【假】你坚称自己从未进入古董店，只在店外烧了一些私人物品。', task: '坚称自己从未进入古董店，只在店外烧了一些私人物品。'} 
            }, 
            scenes: BASIC_SCENES_TEMPLATE, 
            clue_stages: { 
                1: [
                    { title: '1. 烧焦的纸条', detail: '残留着“七星”的字样。绳索断裂处平整。' }, 
                    { title: '2. 死亡方式', detail: '被高处的古董花瓶砸中头部。花瓶展示架顶部有微小的滑轮和一根鱼线。' },
                    { title: '3. 隔壁储物间墙壁', detail: '墙壁有被凿开又填补的痕迹，里面残留着微小的声敏传感器碎片。' }
                ], 
                2: [
                    { title: '4. 店主的幸运铜铃', detail: '铜铃上有微小的摩擦痕迹，声纹分析发现，铜铃声与声敏传感器的触发频率**精确**吻合。' }, 
                    { title: '5. 烧焦纸条残骸', detail: '纸条残骸检测出有盗墓贼特制熏香的成分。' },
                    { title: '6. 误导信息', detail: '花瓶碎片上检测出微量的植物油，与道士张玄的供词吻合。' }
                ] 
            }, 
            truth: '真凶是盗墓贼·钱涛。他安装了声敏传感器，利用店主摇动“幸运铜铃”的声波触发机关，拉断鱼线，制造花瓶坠落意外，并伪装成诅咒。' 
        },
    
        // 案件 10: 证券交易所的午餐 (中等)
        '10': { 
            title: '证券交易所的午餐', tags: '【中等】 【致命细节】 【远程投毒】', description: '金融大佬死于食物过敏。凶手利用了温度控制和气压变化，完成了远程、隐蔽的投毒。', 
            roles: { 
                '秘书·王丽娜': {identity:'王丽娜 (秘书)', secret: '【真】你与竞争对手·赵刚有染，你知道死者的花生过敏，并偷偷检查死者办公室的空调温度。 【假】你声称死者曾威胁你泄露公司的财务机密。', task: '隐瞒你与赵刚的关系，并强调自己只是关心死者的健康。', options: ['秘书·王丽娜', '竞争对手·赵刚', '实习生·林浩', '外卖员·小张'] }, 
                '竞争对手·赵刚': {identity:'赵刚 (竞争对手)', secret: '【真】你在死者午餐前曾去过办公室，目的是调高空调温度，让他感到不适。 【假】你坚称只是打招呼，并指责实习生经常抱怨薪水。', task: '坚称自己去过办公室，但只是打招呼，没有碰任何东西。'}, 
                '实习生·林浩': {identity:'林浩 (实习生)', secret: '【凶手】【真】你利用外卖员制服，将装有花生油的**冰冻胶囊**粘在外卖盒盖内侧，胶囊在温控外卖袋中融化，花生油滴入食物。 【假】你坚称自己一直在茶水间工作，并在午休时间没有离开公司。', task: '坚称自己一直在茶水间工作，并在午休时间没有离开公司。'}, 
                '外卖员·小张': {identity:'小张 (外卖员)', secret: '【真】你发现制服被偷换，温控外卖袋的温控记录在送餐过程中有一次不自然的温度尖峰。 【假】你声称你看到秘书在接外卖时，用手指碰了一下盒盖。', task: '说出制服被偷换和温控记录异常的事实。'} 
            }, 
            scenes: BASIC_SCENES_TEMPLATE, 
            clue_stages: { 
                1: [
                    { title: '1. 监控盲区', detail: '大佬办公桌前有一段3分钟的监控盲区。' }, 
                    { title: '2. 死亡原因', detail: '严重花生过敏导致休克。外卖盒盖内侧有残留。' },
                    { title: '3. 外卖温控记录', detail: '温控外卖袋的记录显示，在进入大佬办公室前，袋内温度曾有一次不正常的突然上升。' }
                ], 
                2: [
                    { title: '4. 实习生的冷库卡记录', detail: '实习生在案发当天早晨，曾频繁进入公司冷库。' }, 
                    { title: '5. 空调系统记录', detail: '竞争对手·赵刚在案发当天曾远程登录系统，将死者办公室的空调温度调高了3度。' },
                    { title: '6. 误导信息', detail: '秘书的抽屉里发现了关于花生过敏的医学文献。' }
                ] 
            }, 
            truth: '真凶是实习生·林浩。他利用冰冻胶囊和温控外卖袋投毒。竞争对手赵刚的调温行为，则无意中加速了胶囊的融化。' 
        },
    
        // 案件 11: 沉船上的幽灵信号 (复杂)
        '11': { 
            title: '沉船上的幽灵信号', tags: '【复杂】 【海事】 【信号逆向利用】', description: '船长为骗保坚持收到废弃灯塔信号，但工程师利用船只自身的系统和船长的贪婪，将假信号变成了真灾难。', 
            roles: { 
                '船长·李明': {identity:'李明 (船长)', secret: '【真】你明知灯塔已拆除，但为索取巨额保险赔偿，伪造了航海日志。 【假】你坚称自己收到了信号，并指责大副·陈涛在日志记录上不够仔细。', task: '坚持自己收到了信号，并转移对保险骗局的怀疑。', options: ['船长·李明', '大副·陈涛', '工程师·赵工', '水手长·老刘'] }, 
                '大副·陈涛': {identity:'陈涛 (大副)', secret: '【真】你发现船长修改航海日志，并知道船长曾秘密将一个旧声纳发射器交给工程师维修。 【假】你声称你看到工程师在机舱门口和船长进行了一次激烈的争吵。', task: '指出航海日志有被修改的痕迹，并说出旧声纳发射器曾交给工程师的事实。'}, 
                '工程师·赵工': {identity:'赵工 (工程师)', secret: '【凶手】【真】你发现船长用旧声纳伪造信号骗保的计划。你利用船上的**冰箱冷却循环时间**和旧声纳的频率，制造了真正误导船只的信号。 【假】你坚称自己一直在机舱工作，并否认与船长有任何争吵。', task: '否认自己使用过声纳，并坚称自己一直在机舱工作。'}, 
                '水手长·老刘': {identity:'老刘 (水手长)', secret: '【真】你看到工程师在船尾秘密调试冰箱的冷却系统，旁边有一个与声纳连接的计时器。 【假】你告诉警方你认为船长修改航海日志是因为他有老花眼，看错了日期。', task: '如实说出看到工程师调试冰箱和计时器的行为。'} 
            }, 
            scenes: BASIC_SCENES_TEMPLATE, 
            clue_stages: { 
                1: [
                    { title: '1. 灯塔记录与船长报告', detail: '灯塔已拆除。船长报告信号是连续三次短闪。' }, 
                    { title: '2. 船只导航日志', detail: '导航日志显示船只曾在不该停留的位置停留了近两小时。' },
                    { title: '3. 船只零件追踪', detail: '船长曾将一个旧声纳发射器交给工程师维修，但维修记录被销毁。' }
                ], 
                2: [
                    { title: '4. 冰箱冷却循环记录', detail: '记录显示，冷却循环的时间规律与信号发出的间隔时间**完美同步**。' }, 
                    { title: '5. 工程师的工具箱', detail: '工具箱内有用于调整冰箱冷却系统计时器的特殊工具。' },
                    { title: '6. 误导信息', detail: '大副陈涛的房间里发现了一份关于购买新导航系统的申请书。' }
                ] 
            }, 
            truth: '真凶是工程师·赵工。他发现船长的骗保计划后，利用船长交给他维修的旧声纳，将其频率与船上冰箱冷却循环的规律时间同步，制造了真正能误导船只的信号。' 
        },
    
        // 案件 12: 咖啡机的秘密 (复杂)
        '12': { 
            title: '咖啡机的秘密', tags: '【复杂】 【日常习惯】 【蒸汽投毒】', description: '受害者死于慢性中毒。凶手利用了死者的“高温消毒”习惯和另一个同事的“好心”行为来实施投毒。', 
            roles: { 
                '同事·张伟': {identity:'张伟 (同事)', secret: '【真】你每天偷偷将咖啡机的水换成纯净水。 【假】你声称你看到秘书在咖啡机旁鬼鬼祟祟，并试图动咖啡粉。', task: '强调咖啡机的水源是安全的，不是中毒的途径。', options: ['同事·张伟', '同事·李娜', '秘书·林思', '保洁员·王大妈'] }, 
                '同事·李娜': {identity:'李娜 (同事)', secret: '【真】你看到秘书经常给死者水杯放维生素。你发现死者有一个习惯，喜欢用咖啡机的**蒸汽喷嘴**先喷一下水杯“消毒”。 【假】你告诉警方你认为死者死于压力过大，曾偷偷给死者寄过匿名信劝他辞职。', task: '指出死者使用蒸汽喷嘴消毒水杯的习惯。'}, 
                '秘书·林思': {identity:'林思 (秘书)', secret: '【凶手】【真】你知道死者用蒸汽喷嘴消毒的习惯。你将微量的慢性毒药涂抹在蒸汽喷嘴内壁。 【假】你坚称自己只是给死者准备维生素，并强调是同事张伟经常动咖啡机的水箱。', task: '坚称自己只是给死者准备维生素，并强调咖啡机的卫生问题。'}, 
                '保洁员·王大妈': {identity:'王大妈 (保洁员)', secret: '【真】你发现死者从不清洗自己的水杯，且总是第一个使用蒸汽喷嘴，喷嘴内部有你清理不掉的微量粘稠物。 【假】你告诉警方你发现死者的水杯底部有一个微小的裂缝。', task: '如实说出死者使用蒸汽喷嘴的频率和喷嘴内部的粘稠物。'} 
            }, 
            scenes: BASIC_SCENES_TEMPLATE, 
            clue_stages: { 
                1: [
                    { title: '1. 咖啡机残留', detail: '水箱和咖啡粉中均未检测出毒物。死亡原因是慢性中毒。' }, 
                    { title: '2. 蒸汽喷嘴残留', detail: '蒸汽喷嘴内壁检测出微量的毒物残留。' },
                    { title: '3. 同事李娜的证词', detail: '死者有使用蒸汽喷嘴对水杯进行“预消毒”的习惯。' }
                ], 
                2: [
                    { title: '4. 死者的水杯', detail: '水杯内壁有微量的毒物残留。' }, 
                    { title: '5. 秘书的药盒', detail: '秘书抽屉里有与死者体内毒物成分相符的慢性毒药空药盒。' },
                    { title: '6. 误导信息', detail: '现场检测到水箱内有微量的纯净水残留，而非自来水。' }
                ] 
            }, 
            truth: '真凶是秘书·林思。她将慢性毒药涂抹在咖啡机的蒸汽喷嘴内壁，利用死者用蒸汽“消毒”杯子的习惯，让毒药缓慢溶解。同事张伟更换纯净水，反而排除了水箱投毒的可能性。' 
        }
    };


        // ===================================================================
        // 2. 核心功能函数 (Functions)
        // ===================================================================
        
        // **文本转语音 (TTS) 功能**
        const synth = window.speechSynthesis;
        let chineseVoice = null;
        
        function getChineseVoice() {
            // 确保 voices 列表已加载
            if (synth.getVoices().length === 0) {
                synth.onvoiceschanged = getChineseVoice;
                return;
            }

            if (chineseVoice) return chineseVoice;
            const voices = synth.getVoices();
            
            // 1. 优先查找标准的普通话（zh-CN）
            chineseVoice = voices.find(voice => 
                voice.lang === 'zh-CN' || 
                voice.name.includes('Mandarin') || // 某些系统会用名称标示
                voice.name.includes('普通话') 
            );

            // 2. 如果标准普通话找不到，退而求其次找任何 zh- 或 cmn- 开头的声音
            if (!chineseVoice) {
                chineseVoice = voices.find(voice => 
                    voice.lang.startsWith('zh-') || voice.lang.startsWith('cmn-')
                );
            }

            // 3. 如果以上都找不到，使用第一个声音作为备用
            if (!chineseVoice) {
                chineseVoice = voices[0]; 
            }
            return chineseVoice;
        }

        function speakNarrative(text) {
            if (!game.ttsOn || !synth) return; 

            // 如果正在播放，先停止
            if (synth.speaking) {
                synth.cancel();
            }

            // 清理文本中的【旁白】、【主持人】等标签，以便朗读更自然
            const cleanText = text.replace(/【[^】]+】/g, '').replace(/\*\*([^*]+)\*\*/g, '$1');

            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.voice = getChineseVoice();
            utterance.lang = 'zh-CN';
            utterance.rate = 1.0; // 语速
            utterance.pitch = 1.0; // 音调
            
            synth.speak(utterance);
        }
        
        function stopSpeaking() {
            if (synth.speaking) {
                synth.cancel();
            }
        }
        
        // 初始化获取声音
        getChineseVoice();


        /**
         * 场景切换逻辑
         */
        function goToScene(sceneId) {
            document.querySelectorAll('.scene').forEach(scene => {
                scene.classList.remove('active');
            });
            stopSpeaking(); 
            document.getElementById(sceneId).classList.add('active');
            
            if (sceneId === 'scene-case-select') {
                resetGame();
            }
        }


        /**
         * 加载并显示当前剧本中的场景内容
         */
        function loadScene(currentCaseData) {
            const scenes = currentCaseData.scenes;
            if (game.currentSceneIndex >= scenes.length) {
                goToScene('scene-case-select');
                return;
            }
            
            const scene = scenes[game.currentSceneIndex];
            const sceneType = scene.type;

            // 设置场景图片
            const imageEl = document.getElementById('scene-main-image');
            const defaultImageUrl = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22100%25%22%20height%3D%22300%22%20viewBox%3D%220%200%20100%20300%22%20preserveAspectRatio%3D%22none%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22300%22%20fill%3D%22%23000000%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20fill%3D%22%23FFFFFF%22%20font-size%3D%2212%22%20font-family%3D%22Arial%2C%20sans-serif%22%20text-anchor%3D%22middle%22%3E%5B%E5%9C%BA%E6%99%AF%E6%8F%92%E5%9B%BE%E5%8D%A0%E4%BD%8D%E7%AC%A6%5D%3C%2Ftext%3E%3C%2Fsvg%3E';
            if (imageEl) {
                const imageUrl = SCENE_IMAGES[game.currentCaseId] || defaultImageUrl;
                imageEl.src = imageUrl;
            }
            
            stopSpeaking(); // 停止所有朗读

            switch (sceneType) {
                case 'narrative':
                    // 旁白场景
                    goToScene('scene-narrative');
                    document.getElementById('narrative-text').innerHTML = scene.text.replace(/\n/g, '<br>');
                    
                    // 核心朗读功能调用
                    speakNarrative(scene.text); 
                    
                    document.getElementById('continue-story-btn').textContent = "继续故事 ▶";
                    document.getElementById('continue-story-btn').onclick = () => {
                        game.currentSceneIndex++;
                        loadScene(currentCaseData);
                    };
                    break;
                
                case 'select_role':
                    // 角色选择场景
                    goToScene('scene-role-select');
                    const roleNames = Object.keys(currentCaseData.roles).join(', ');
                    document.getElementById('role-name-options').textContent = `可输入角色名: ${roleNames}`;
                    document.getElementById('role-name-input').value = '';
                    document.getElementById('role-script-display').innerHTML = '';
                    document.getElementById('confirm-role-btn').textContent = "确认";
                    
                    speakNarrative("请各位玩家确认自己的角色剧本，输入你的角色全名。");
                    break;

                case 'clues_stage':
                    // 线索搜证场景
                    goToScene('scene-clues');
                    game.currentClueStage = scene.stage;
                    loadClues(currentCaseData.clue_stages[game.currentClueStage]);
                    
                    speakNarrative(`第${game.currentClueStage}轮搜证开始。本次搜证有${currentCaseData.clue_stages[game.currentClueStage].length}条线索。`);
                    break;
                    
                case 'reveal':
                    // 真相揭晓场景
                    goToScene('scene-reveal');
                    document.getElementById('truth-display').textContent = currentCaseData.truth;
                    
                    speakNarrative("真相揭晓环节。请大家给出最终指认。");
                    break;
                    
                default:
                    game.currentSceneIndex++;
                    loadScene(currentCaseData);
            }
        }

        /**
         * 加载线索列表
         */
        function loadClues(clues) {
            const container = document.getElementById('clue-list-container');
            container.innerHTML = '';
            document.getElementById('clue-stage-info').textContent = `本次搜证有 ${clues.length} 条线索 (第 ${game.currentClueStage} 轮搜证)。`;

            clues.forEach((clue, index) => {
                const clueDiv = document.createElement('div');
                clueDiv.classList.add('clue-item');
                clueDiv.innerHTML = `<h3>${clue.title}</h3><p>${clue.detail}</p>`;
                container.appendChild(clueDiv);
            });

            document.getElementById('finish-clues-btn').onclick = () => {
                game.currentSceneIndex++;
                loadScene(game.currentCaseData);
            };
        }


        /**
         * 重置游戏状态
         */
        function resetGame() {
            game.currentCaseId = null;
            game.currentCaseData = null;
            game.currentSceneIndex = 0;
            game.roleName = null;
            game.currentClueStage = 1;
            document.getElementById('role-script-display').innerHTML = '';
            stopSpeaking(); 
        }

        // ===================================================================
        // 3. 事件监听器和初始化
        // ===================================================================

        // 初始化案件列表
        function renderCaseList() {
            const container = document.getElementById('case-list-container');
            container.innerHTML = '';
            for (let i = 1; i <= 12; i++) {
                const caseId = i.toString().padStart(2, '0');
                const data = GAME_DATA[caseId];
                if (!data) continue; 

                const card = document.createElement('div');
                card.classList.add('case-card');
                card.setAttribute('data-case-id', caseId);

                card.innerHTML = `
                    <h2>案件 ${caseId}: ${data.title}</h2>
                    <p class="case-tags">${data.tags}</p>
                    <p>${data.description}</p>
                    <button class="confirm-button" style="width:100%;">开始案件</button>
                `;

                card.onclick = () => {
                    startGame(caseId);
                };
                container.appendChild(card);
            }
        }
        
        // 启动游戏
        function startGame(caseId) {
            game.currentCaseId = caseId;
            game.currentCaseData = GAME_DATA[caseId];
            game.currentSceneIndex = 0;
            loadScene(game.currentCaseData);
        }

        // 角色确认按钮逻辑
        document.getElementById('confirm-role-btn').onclick = () => {
            const inputName = document.getElementById('role-name-input').value.trim();
            const roles = game.currentCaseData.roles;
            const normalizedInput = inputName.toLowerCase();
            
            // 匹配角色名，允许部分匹配（例如输入“林小梅”匹配“女佣·林小梅”）
            const matchingRoleName = Object.keys(roles).find(
                key => key.toLowerCase() === normalizedInput || key.toLowerCase().includes(normalizedInput)
            );

            if (matchingRoleName) {
                game.roleName = matchingRoleName;
                const roleData = roles[matchingRoleName];
                const displayArea = document.getElementById('role-script-display');
                
                displayArea.innerHTML = `
                    <h2>你好，${matchingRoleName}。这是你的剧本:</h2>
                    <p><strong>【你的身份】</strong> <span>${roleData.identity}</span></p>
                    <p><strong>【你的秘密】</strong> <span>${roleData.secret}</span></p>
                    <p><strong>【你的任务】</strong> <span>${roleData.task}</span></p>
                    <button class="action-btn" id="read-done-btn">已阅读，进入故事</button>
                `;
                
                // 朗读剧本内容
                speakNarrative(`你好，${matchingRoleName}。你的身份是${roleData.identity}。你的秘密是${roleData.secret}。你的任务是${roleData.task}。`);

                document.getElementById('read-done-btn').onclick = () => {
                    stopSpeaking(); // 停止朗读剧本
                    game.currentSceneIndex++;
                    loadScene(game.currentCaseData);
                };

            } else {
                alert(`角色名输入错误，请检查。请确保输入的是以下角色之一：${Object.keys(roles).join('、')}`);
            }
        };
        
        // **TTS 切换逻辑**
        document.getElementById('tts-toggle').onclick = function() {
            if (game.ttsOn) {
                stopSpeaking(); // 关闭时停止当前的朗读
                game.ttsOn = false;
                this.textContent = "🔊 TTS: 关";
                this.classList.remove('tts-on');
            } else {
                game.ttsOn = true;
                this.textContent = "🔊 TTS: 开";
                this.classList.add('tts-on');
                
                if (!synth) {
                    alert("警告：当前浏览器不支持 TTS（Web Speech API）。");
                } else {
                    // 如果在旁白场景开启，重新朗读当前旁白
                    const narrativeEl = document.getElementById('narrative-text');
                    if (narrativeEl && narrativeEl.closest('.scene').classList.contains('active')) {
                        speakNarrative(narrativeEl.textContent);
                    }
                }
            }
        };


        // 菜单弹窗逻辑
        const menuModal = document.getElementById('menu-modal');
        document.getElementById('menu-btn').onclick = () => {
            menuModal.style.display = "block";
        };
        document.getElementById('close-menu').onclick = () => {
            menuModal.style.display = "none";
        };
        window.onclick = (event) => {
            if (event.target == menuModal) {
                menuModal.style.display = "none";
            }
        };

        // 页面加载完成时渲染案件列表
        window.onload = renderCaseList;

    </script>
</body>
</html>
